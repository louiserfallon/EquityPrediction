---
title: "Big Data In Finance Individual Assignment"
author: "Louise Fallon"
output: pdf_document
---

```{r setup, include=FALSE}
library(readxl) #for read_excel
library(ggplot2) #for ggplot
library(forecast) #for ggseasonplot and autoplot etc
library(reshape2) #for melt
library(condformat) #for condformat and rule_fill_discrete
library(glmnet) #for cv.glmnet (LASSO and elastic nets)
library(randomForest) #for randomForest
library(gbm) #for gbm
library(knitr) #for kable
library(gridExtra) #for gridarrange
library(vars) #for var
knitr::opts_chunk$set(cache = FALSE, echo=FALSE)
```

## Introduction & Data

Using daily data on value-weighted returns from 49 industry-based portfolios, multiple algorithms are trained and compared to predict future returns for each industry.

```{r fig.height=3.5, fig.align='center'}
#load data
returns <- as.data.frame(read_excel("Data.xlsx", sheet = 1, col_names = TRUE, skip=3))
#remove lagged spaces in column names
for (i in 1:ncol(returns)) colnames(returns)[i] <- gsub(" ","",colnames(returns)[i])
#remove row of NAs at the bottom
returns <- returns[complete.cases(returns),]
#add date column header
names(returns)[1] <- "date"
#plot boxplot of returns
meltedreturns <- melt(returns, id.vars = "date")
ggplot(meltedreturns, aes(x=variable, y=value)) +
  geom_boxplot(col="#000066") + 
  theme_bw() + 
  theme(legend.position="none",
        axis.text.x = element_text(angle = 90, vjust=0.5, size=6)) +
  xlab("Industry") + ylab("Daily Returns")
```

The daily industry returns shown above are generally centered around 0, the lowest average return is for Coal at `r format(min(colMeans(returns[,2:50])),digits=3)`, and the highest is for Gold at `r format(max(colMeans(returns[,2:50])),digits=3)`, with clear differences in industry return variance ranging from 
`r format(min(apply(returns[,2:50], 2, var)),digits=3)` for Household, and `r format(max(apply(returns[,2:50], 2, var)),digits=3)` for Coal. For this data to build a useful predictive model, we require a relationship between industry returns and lagged returns either in the same industry, or across other industries.

If industry momentum is a real phenomenon, as per (Grinblatt and Moskowitz 1999), whereby industries that are performing well continue to do so, and industries that are not performing well also continue to do so, then we would expect to see a correlation between current returns with previous returns, within an industry. The analysis here differs from the Grinblatt & Moskowitz paper in that it focuses on daily price changes and lags, rather than monthly. One of the reasons why we may expect to see momentum, as explained by (Hong and Stein 1999), is when information slowly diffuses through the network of investors, prices underreact to news in the short term as not everyone has heard the news, and overreact in the long term due to momentum traders. This is something we may expect to see at the daily return level. If past performance has a relationship with future performance, either positively or negatively, but at least consistently, then including lagged variables of returns within the industry will be beneficial for a predictive model.

Additionally, if there are reliable relationships between one industry's current returns and lagged returns of other industries in the dataset, then this would also be beneficial for predictive model building, and non-linear models could also make use of any interactions between industry returns. We might expect to see positive cross-correlations in occasions where there is an upstream/downstream industry relationship e.g. with Textiles and Clothes, where information is gradually diffused (Menzly and Obas 2010), or where there are differences in analyst coverage (Brennan, Jegadeesh and Swaminathan 1993) such that industries with high levels of average coverage "lead" industies with lower levels. 

#Cross-correlation

```{r fig.height=3}
corrmatrix <- matrix(0, ncol=49,nrow=49)
plotlist <- list()
for (lag in 1:6){
  for (i in 1:49){
    for (j in 1:49){
#correlating the current value of i, with the lagged value of j
#starting from second period so that lagged values can be calculated
#the +1 is to avoid the date column
    corrmatrix[i,j] <- round(cor(returns[(lag+1):nrow(returns),i+1],
                                 returns[1:(nrow(returns)-lag),j+1]), 2)
    }
  }
melteddf<- melt(corrmatrix)
plotlist[[lag]] <- ggplot(data = melteddf, aes(x = Var1, y = Var2, fill = value)) + 
    geom_tile() + 
    labs(x = "", y = "", title = "") +
    theme_bw() + ylab("Industry returns at time t") + xlab(paste("Industry returns at time t-",lag,sep="")) + theme_void() +
     theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.x = element_blank(),
          axis.ticks.y = element_blank(),
          axis.title=element_text(size=8, color="#888888"),
          panel.border = element_blank(),
          legend.position = 'none') + 
  scale_fill_gradient2(low = "#ce1254",mid="#ffffff", high = "#006699",
                       midpoint = 0, limit = c(-.2,.2), space = "Lab",
                       name="Pearson\nCorrelation") 
}

corrtest <- matrix (0, nrow=49, ncol=49)
##recreate correlation matrix for lag 4, including test
for (i in 1:49){
  for (j in 1:49){
    corrmatrix[i,j] <- round(cor(returns[5:nrow(returns),i+1],
                                 returns[1:(nrow(returns)-4),j+1]), 2)
    corrtest[i,j] <- cor.test(returns[5:nrow(returns),i+1],
                                 returns[1:(nrow(returns)-4),j+1])$p.value
  }
}
```

In almost all cases the contemporaneous correlations are found to be positive, which is generally showing that the overall market moves in a similar direction, potentially according to business cycle trends. The only clear anomaly in this case is Gold, which has much lower correlation, and in some cases a slighty negative correlation against Clothes and Banks, which is likely due to the fact that gold is often used as a hedge against stocks, and gold companies also carry this effect (Baur and Lucey 2010). This contemporaneous information is not particularly useful for the predictive task at hand, as prediction will be made for a time period in the future, when returns of other industries in that future time period will not be known.

The plots below show the correlations between the industry returns at time t, against their returns at various lags. At lags of 2 and 4 there is a clear pattern of negative cross correlations, except for some outlier industries (these include Gold, Coal, Oil and interestingly for lag 4 also Fun). This negative cross-correlation is not in line with the results from (Lo and MacKinlay 1990), where they see a positive cross-correlation. The effect we could be seeing here is a "balancing" effect where short-term investors, potentially following a momentum strategy, move money out of poorly performing industries and reinvest that money in other industries within a time frame of 2 or 4 days, pushing up the price in those industries and vice versa.

Regardless of the sign, if these correlations are significant then they are expected to be useful within the predictive models, which for lag=4, `r length(corrtest[corrtest<0.1])` are at the 10% significance level, and `r length(corrtest[corrtest<0.05])` are at the 5% significance level. Although this is only a percentage of the `r 49*49` possible combinations, algorithms that deal with scarcity can use these to aid prediction e.g. the LASSO method (Chinco, Clark-Joseph and Ye 2017). What is not clear from these correlation plots is a clear pattern along the diagonal, implying auto-correlation in either direction may not be strong, this is tested further in the next section.

```{r}
grid.arrange(plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],plotlist[[5]],plotlist[[6]], nrow=2)
```

#Auto-correlation

Using a Box-Pierce test each industry return series was tested for autocorrelation with lags up to 10 working days. The results displayed below show the correlation between the returns at time t and returns at time t-lag, and are highlighted in bold when the Box-Pierce test implies that these are statistically significant at the 10% level, providing that there is evidence of autocorrelation. This shows that in most cases there is no statistically significant autocorrelation for an industry portfolio, but in cases where there is autocorrelation, this is often negative (in fact, for lags up to 4 all significant autocorrelations are negative except for Steel).

```{r cache=FALSE}
boxpiercevalue <- matrix(0, nrow = 49, ncol = 10) 
autocorrelations <- matrix(0, nrow = 49, ncol = 10) 
for (i in 1:49){
  for (j in 1:10){
    boxpiercevalue[i,j] <- round(Box.test(ts(returns[,i+1],
                                       start=c(1,20),
                                       frequency=252), lag=j)$p.value,3)
    autocorrelations[i,j] <- round(cor(returns[(1+j):nrow(returns),i+1],
                                       returns[1:(nrow(returns)-j),i+1]),3)
  }
}

autocorrelationsdf <- as.data.frame(autocorrelations)
autocorrelationsdf <- cbind(names(returns)[2:50],autocorrelationsdf)
names(autocorrelationsdf) <- c("Industry","Lag 1","Lag 2","Lag 3",
                        "Lag 4","Lag 5","Lag 6","Lag 7",
                        "Lag 8","Lag 9","Lag 10")


pval <- 0.1
condtable <- condformat(autocorrelationsdf) + 
                     rule_fill_discrete(2,
                     expression =  boxpiercevalue[,1] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                     rule_fill_discrete(3,
                     expression = boxpiercevalue[,2] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                      rule_fill_discrete(4,
                     expression = boxpiercevalue[,3] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                      rule_fill_discrete(5,
                     expression = boxpiercevalue[,4] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                      rule_fill_discrete(6,
                     expression = boxpiercevalue[,5] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                      rule_fill_discrete(7,
                     expression = boxpiercevalue[,6] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                      rule_fill_discrete(8,
                     expression = boxpiercevalue[,7] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                      rule_fill_discrete(9,
                     expression = boxpiercevalue[,8] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                      rule_fill_discrete(10,
                     expression = boxpiercevalue[,9] < pval,
                     colours = c("TRUE" = "#dddddd")) +
                      rule_fill_discrete(11,
                     expression = boxpiercevalue[,10] < pval,
                     colours = c("TRUE" = "#dddddd"))
condtable
```

#Model Building

Models were built to predict at time $\tau$, using data known at time $\tau$, the value of industry returns at time $\tau + 1$, using a rolling training window of 80 days ($\tau-80 to \tau-1$), to identify out of sample performance as per the model of (Goyal and Welch 2008).

The first model is a pure linear OLS model of returns as a function of the previous day's returns within the industry [Linear Own 1]. The second is a linear model of returns a function of the 4 previous day's returns within the industry [Linear Own 4]. The third is a linear model of returns as a function of the previous day's returns from all industries [Linear All 1].  The fourth is a LASSO model of returns as a function of the previous day's returns from all industries, this improves on the linear OLS model by penalising parameters [LASSO All 1], and therefore removing those that are not relevant within the time period, or that are in a group of multicollinear variables, of which only the most predictive variables are chosen (Chinco 2017). The fifth is a LASSO model using 4 lags from all industries [LASSO 4]. The sixth is LASSO model using 4 lags from all industries, and also including an indicator variable of whether there was a front page news article from the social media news aggregation platform Reddit containing the words of one of the major companies within that industry [LASSO 4 news], follwing on from many pieces of analysis that attempt to include news sources in financial prediction, e.g. (Hagenau. 2013).

Other machine learning techniques were applied as part of this analysis: random forests and general boosting methods using both gaussian and laplace distributions, the results in terms of industry and lag structure were broadly similar, so results are not included here for purposes of space.

The results of these models are outlined below:

```{r window}
windowlength <- 80
```

*to include*

```{r goyal}
#For Goyal plots

#function to get cumulative sums of a dataframe
colCumSums <- function(x) {
  for(i in seq_len(dim(x)[2])) { x[,i] <- cumsum(x[,i]) }; x
}

```


## References

Baur, D.G., Lucey, B. M., (2010) Is Gold a Hedge or a Safe Haven? An Analysis of Stocks, Bonds and Gold *The Financial Review* 45(2), 217–229.

Campbell, J., Thompson,S. (2008) Predicting Excess Stock Returns Out of Sample: Can anything Beat the Historical Average? *Review of Financial Studies* 21, 1509-1531.

Chinco, A., Clark-Joseph, A., and M. Ye, (2017) Sparse Signals in the Cross-Section of Returns, Working paper. Accessible at: http://www.alexchinco.com/sparse-signals-in-cross-section.pdf [Accessed 10th April 2017]

DeMiguel, V., Nogales F. J, Uppal, R. (2014) Stock Return Serial Dependence and
Out-of-Sample Portfolio Performance, *Review of Financial Studies* 27 (4), 1031–
1073.

Goyal, A., Welch, I. (2007) A Comprehensive Look at the Empirical Performance of Equity Premium Prediction. *Review of Financial Studies, Oxford University Press for Society for Financial Studies* 21(4), 1455-1508. 

Hagenau. M, Leibemann, M. Neumann. D. (2013) Automated news reading: Stock price prediction based on financial news using context-capturing features. *Decision Support Systems* 55(3), 685-697.

Lo, A., MacKinlay A. C. (1990) When are contrarian profits due to stock market overreaction? *Review of Financial Studies* 3(2), 175–205.

Moskowitz, T., Grinblatt M (1999) Do Industries Explain Momentum? *The Journal of Finance* 54 (4), 1249-1290. 

Menzly, L., Ozbas O. (2010) Market segmentation and cross-predictability of returns. *Journal of Finance* 65, 1555–80.

It is well known that momentum is not the same as positive autocorrelation: momentum is a cross-sectional result (winners beat losers), while autocorrelation is a time-series phenomenon (a stock's past and future returns are correlated).
http://finance.martinsewell.com/stylized-facts/dependence/Lewellen2002.pdf
Negative x correlation month -> year.

VAR: https://cran.r-project.org/web/packages/vars/vignettes/vars.pdf

Journal of Statistical Software
October 2006, Volume 17, Issue 2. http://www.jstatsoft.org/

News Implied Volatility and Disaster Concerns http://faculty.som.yale.edu/alanmoreira/Papers/NVIX.pdf

https://www.treasury.gov/resource-center/data-chart-center/interest-rates/Pages/TextView.aspx?data=billRatesYear&year=2015
